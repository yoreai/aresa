# ARESA Studio - Integration Test Environment
#
# This docker-compose file sets up all supported database types
# with sample data for testing ARESA Studio's features.
#
# Includes mock servers for cloud platforms (Snowflake, Databricks)
#
# Usage:
#   make up      # Start all databases + mock servers
#   make test    # Run integration tests
#   make serve   # Start ARESA Studio
#   make clean   # Stop and remove volumes

services:
  # ============================================
  # Mock Cloud Server (Snowflake + Databricks)
  # ============================================
  mock-cloud:
    build:
      context: ./mock-cloud
      dockerfile: Dockerfile
    container_name: aresa-test-mock-cloud
    ports:
      - "8443:8443"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8443/health"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ============================================
  # PostgreSQL - Primary relational database
  # ============================================
  postgres:
    image: postgres:16-alpine
    container_name: aresa-test-postgres
    environment:
      POSTGRES_USER: aresa
      POSTGRES_PASSWORD: aresa_test_123
      POSTGRES_DB: aresa_test
    ports:
      - "5433:5432"  # Use 5433 to avoid conflicts with local postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U aresa -d aresa_test"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ============================================
  # MySQL - Popular relational database
  # ============================================
  mysql:
    image: mysql:8.0
    container_name: aresa-test-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root_test_123
      MYSQL_USER: aresa
      MYSQL_PASSWORD: aresa_test_123
      MYSQL_DATABASE: aresa_test
    ports:
      - "3307:3306"  # Use 3307 to avoid conflicts
    volumes:
      - mysql_data:/var/lib/mysql
      - ./mysql/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "aresa", "-paresa_test_123"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ============================================
  # ClickHouse - Analytics database
  # ============================================
  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: aresa-test-clickhouse
    environment:
      CLICKHOUSE_DB: aresa_test
    ports:
      - "8124:8123"  # HTTP interface (use 8124 to avoid conflicts)
      - "9001:9000"  # Native interface
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./clickhouse/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - ./clickhouse/users.xml:/etc/clickhouse-server/users.d/users.xml:ro
    healthcheck:
      test: ["CMD", "clickhouse-client", "--query", "SELECT 1"]
      interval: 5s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
  mysql_data:
  clickhouse_data:

networks:
  default:
    name: aresa-test-network

